# 💰 Краткий анализ раздела "Финансы"

**Ветка:** `feature/finances-improvements`  
**Дата:** 2025-10-02

---

## 📌 Главная проблема

**Сейчас:** Информация о долгах разбросана по 6 разным разделам. Непонятно:
- Кто кому должен прямо сейчас?
- Какой долг закрывать первым?
- Сколько накопилось долгов за всё время?

---

## 🔴 Основные проблемы (7 штук)

| # | Проблема | Критичность |
|---|----------|-------------|
| 1 | **Дублирование раздела** "Долг модераторов" появляется 2 раза | 🔴 Высокая |
| 2 | **Нет единого dashboard** с текущими долгами | 🔴 Высокая |
| 3 | **Только периоды**, нет накопленных долгов | 🟠 Средняя |
| 4 | **Неудобный UI**: модальные окна, ручной ввод partner_id | 🟠 Средняя |
| 5 | **Нет автоматизации** для инвестиционных балансов | 🟠 Средняя |
| 6 | **Нет приоритетов** долгов | 🟡 Низкая |
| 7 | **Нет валидации** переводов | 🟡 Низкая |

---

## ✅ Что предлагается

### **1. Единый раздел "Текущие долги"** 🔴 Приоритет #1

Таблица вверху страницы:

```
┌──────────┬────────────┬──────────┬──────────┬─────────────┬────────────┬───────────┐
│ Приор.   │ Кто должен │ Кому     │ Сумма    │ Тип долга   │ Период     │ Действие  │
├──────────┼────────────┼──────────┼──────────┼─────────────┼────────────┼───────────┤
│ 🔴 P1    │ Модератор1 │ Admin    │ 500 PLN  │ Собранные   │ 01.09-30.09│ [Перевод] │
│ 🟠 P2    │ Admin      │ Владелец2│ 300 PLN  │ Ребаланс    │ 01.09-30.09│ [Перевод] │
│ 🟡 P3    │ Владелец1  │ Владелец2│ 3000 PLN │ Вложения    │ Всё время  │ [Перевод] │
└──────────┴────────────┴──────────┴──────────┴─────────────┴────────────┴───────────┘
```

**Приоритеты:**
- 🔴 **P1** - Модераторы → Владельцы (собранные деньги) - **СРОЧНО**
- 🟠 **P2** - Ребаланс собранных между владельцами (50/50) - **СРЕДНЕ**
- 🟡 **P3** - Выравнивание инвестиций (закупки) - **НЕСРОЧНО**

---

### **2. Режим "Накопленные долги"** 🟠 Приоритет #2

Переключатель:
- 📅 **За период** (текущий месяц / прошлый / произвольный)
- 📊 **Накопленные** (с начала проекта / с даты X)

**Пример:**
```
Долг Модератора1 владельцам (накопленный):
Период        | Собрал | Перевёл | Долг
--------------+--------+---------+-------
Сентябрь 2025 | 5000   | 4500    | 500
Август 2025   | 4800   | 4300    | 500
--------------+--------+---------+-------
ИТОГО:                           | 1000 PLN
```

---

### **3. Автоматизация инвестиций** 🟡 Приоритет #3

В разделе "Вложено в бизнес" добавить кнопки:

```
Владелец  | Вложил | Доля  | Баланс  | Действие
----------+--------+-------+---------+------------------
Владелец1 | 5000   | 8000  | -3000   | [❌ Должен доплатить]
Владелец2 | 3000   | 8000  | -5000   | [❌ Должен доплатить]
```

**Если баланс < 0:** кнопка "Создать перевод" для выравнивания

---

### **4. История расчётов** 🟢 Дополнительно

Под каждым долгом показывать:
```
📋 История:
  2025-09-15: Перевод 300 PLN (осталось 200)
  2025-09-22: Перевод 100 PLN (осталось 100)
  2025-09-30: Перевод 100 PLN ✅ (ЗАКРЫТО)
```

---

### **5. Валидация переводов** 🟢 Дополнительно

Проверки перед созданием:
- ✅ Достаточно ли средств в "собранных"?
- ✅ Не превышает ли сумма долг?
- ✅ Не создаётся ли перевод "сам себе"?
- ⚠️ **Предупреждение:** "Вы переводите больше, чем долг (500 > 450)"

---

## 📐 Формулы расчёта

### Долг модератора (за период):
```
Debt = SUM(payments by moderator) - SUM(transfers MODERATOR_TO_OWNER from moderator)
```

### Ребаланс собранных (2 владельца, 50/50):
```
Transfer = (Collected_A - Collected_B) / 2
```
Если > 0: A → B, иначе B → A

### Баланс инвестиций:
```
Invested = (Purchases × 50%) + Deposits
Fair_Share = Total_Purchases / Num_Owners
Balance = Invested - Fair_Share
```
Если < 0: владелец должен доплатить

---

## 📊 Текущие разделы (что есть сейчас)

1. **Долг модераторов** (×2 дубликат!) - кто должен перечислить
2. **Собранные** - остатки на счетах партнёров
3. **Вложено в бизнес** - кто сколько вложил в закупки
4. **Взаиморасчёты владельцев** - история переводов
5. **Ребаланс собранных** - рекомендации по выравниванию
6. **Распределение прибыли** - кому сколько полагается из прибыли

---

## 🎯 План действий

### Этап 1: Критические исправления
- [ ] **Удалить дубликат** "Долг модераторов"
- [ ] **Создать раздел** "Текущие долги" с приоритетами
- [ ] **Добавить режим** "Накопленные долги"

### Этап 2: Автоматизация
- [ ] **Кнопки "Создать перевод"** для инвестиций
- [ ] **Автозаполнение** сумм и партнёров
- [ ] **Валидация** перед созданием

### Этап 3: UX
- [ ] **Цветовая кодировка** долгов (🔴🟠🟡)
- [ ] **Tooltips** для терминов ("Собранные", "Вложено")
- [ ] **История расчётов** под каждым долгом

---

## 📝 Файлы анализа

1. **FINANCE_ANALYSIS.md** - полный анализ (370 строк)
2. **КРАТКИЙ_АНАЛИЗ_ФИНАНСОВ.md** - этот файл
3. **finance_analysis_summary.png** - визуализация проблем
4. **finance_proposed_structure.png** - предлагаемая структура

---

## 🤔 Вопросы для обсуждения

1. **Приоритеты:** Согласны ли вы с порядком (Модераторы → Ребаланс → Инвестиции)?
2. **Накопленные долги:** Нужен ли режим "За всё время"?
3. **Автоматизация:** Какие кнопки нужнее всего?
4. **UI:** Какие улучшения критичны?

---

**Следующий шаг:** Обсудить с пользователем приоритеты и начать реализацию

{% extends "admin/change_list.html" %}
{% load static %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'admin/css/autocomplete.css' %}">
  <link rel="stylesheet" href="{% static 'admin/css/custom.css' %}">
{% endblock %}

{% block extrahead %}
  {{ block.super }}
  <script src="{% static 'admin/js/vendor/select2/select2.full.js' %}"></script>
  <script src="{% static 'admin/js/autocomplete.js' %}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const sel = document.getElementById('id_rental_filter');
      if (sel) {
        sel.addEventListener('change', function(){ this.form && this.form.submit(); });
      }
      
      // Row highlighting –ø–æ —Ç–∏–ø—É –ø–ª–∞—Ç–µ–∂–∞
      document.querySelectorAll('#result_list tbody tr').forEach(row => {
        const typeCell = row.querySelector('.field-type_display');
        if (typeCell) {
          const badgeElem = typeCell.querySelector('.badge');
          if (badgeElem) {
            const classList = badgeElem.classList;
            if (classList.contains('bg-success')) {
              row.classList.add('payment-type-rent');
            } else if (classList.contains('bg-primary')) {
              row.classList.add('payment-type-deposit');
            } else if (classList.contains('bg-warning')) {
              row.classList.add('payment-type-return');
            } else if (classList.contains('bg-info')) {
              row.classList.add('payment-type-sold');
            } else if (classList.contains('bg-secondary')) {
              row.classList.add('payment-type-adjustment');
            }
          }
        }
      });
    });
  </script>
{% endblock %}

{% block toplinks %}
  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –ø–∞–Ω–µ–ª—å -->
  {% if stats %}
  <div class="stats-panel card mb-3" style="margin: 0.5rem;">
    <div class="card-body py-3">
      <div class="row text-center">
        <div class="col-md-4">
          <h4 class="mb-0 text-primary">{{ stats.total_amount|floatformat:2 }} <small class="text-muted">PLN</small></h4>
          <small class="text-muted">–û–±—â–∞—è —Å—É–º–º–∞</small>
        </div>
        <div class="col-md-4">
          <h4 class="mb-0 text-success">{{ stats.count }}</h4>
          <small class="text-muted">–ü–ª–∞—Ç–µ–∂–µ–π</small>
        </div>
        <div class="col-md-4">
          <h4 class="mb-0 text-info">{{ stats.avg_amount|floatformat:2 }} <small class="text-muted">PLN</small></h4>
          <small class="text-muted">–°—Ä–µ–¥–Ω–∏–π –ø–ª–∞—Ç–µ–∂</small>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- –§–∏–ª—å—Ç—Ä –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É -->
  <form method="get" class="d-flex gap-2 align-items-center" style="padding: .25rem .5rem;">
    <label for="id_rental_filter" class="me-2">–î–æ–≥–æ–≤–æ—Ä:</label>
    <select
      name="rental__id__exact"
      id="id_rental_filter"
      class="admin-autocomplete"
      data-app-label="rental"
      data-model-name="payment"
      data-field-name="rental"
      style="min-width: 320px;"
    >
      {% if selected_rental %}
        <option value="{{ selected_rental.pk }}" selected>
          {{ selected_rental.contract_code }} ‚Äî {{ selected_rental.client.name }}
        </option>
      {% endif %}
    </select>
    {% if request.GET.rental__id__exact %}
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'admin:rental_payment_changelist' %}">–°–±—Ä–æ—Å–∏—Ç—å</a>
    {% endif %}
  </form>
  
  <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞ -->
  {% if selected_rental and rental_balance %}
  <div class="selected-rental-card card mt-2" style="margin: 0.5rem;">
    <div class="card-body py-2">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <h6 class="mb-1">
            <strong>{{ selected_rental.contract_code }}</strong>
            <span class="badge bg-{{ selected_rental.status|default:'secondary' }} ms-2">
              {{ selected_rental.get_status_display }}
            </span>
          </h6>
          <p class="mb-0 text-muted">{{ selected_rental.client.name }}</p>
        </div>
        <div class="text-end">
          <span class="badge bg-{{ rental_balance.color }} fs-6 px-3 py-2">
            –ë–∞–ª–∞–Ω—Å: {{ rental_balance.balance|floatformat:2 }} PLN
          </span>
          <div class="mt-2">
            <small class="text-muted">
              –î–æ–ª–∂–µ–Ω: <strong>{{ rental_balance.charges|floatformat:2 }}</strong> |
              –û–ø–ª–∞—á–µ–Ω–æ: <strong>{{ rental_balance.paid|floatformat:2 }}</strong>
            </small>
          </div>
          <div class="mt-2">
            <a href="{% url 'admin:rental_client_change' selected_rental.client.id %}" class="btn btn-sm btn-outline-primary">
              üë§ –ö –∫–ª–∏–µ–Ω—Ç—É
            </a>
            <a href="{% url 'admin:rental_rental_change' selected_rental.id %}" class="btn btn-sm btn-outline-success">
              üìÑ –ö –¥–æ–≥–æ–≤–æ—Ä—É
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
{% endblock %}

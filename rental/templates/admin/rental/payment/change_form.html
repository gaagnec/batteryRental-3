{% extends "admin/change_form.html" %}
{% load static %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'admin/css/custom.css' %}">
  <style>
    /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –∫–∞–∫ –Ω–∞ dashboard */
    body {
        background-color: #0b0d1a !important;
    }
    
    #content {
        background-color: #0b0d1a !important;
    }
    
    .module, .card {
        background-color: #1c1e2d !important;
        border-color: #2a2e41 !important;
        color: #e3e6ed !important;
    }
    
    .module h2, .module caption, .inline-group h2 {
        background-color: #0e1018 !important;
        color: #e3e6ed !important;
        border-bottom: 1px solid #2a2e41 !important;
    }
    
    fieldset {
        background-color: #1c1e2d !important;
        border-color: #2a2e41 !important;
    }
    
    fieldset h2 {
        background-color: #0e1018 !important;
        color: #e3e6ed !important;
        border-bottom: 1px solid #2a2e41 !important;
        padding: 0.75rem 1rem !important;
        font-weight: 500 !important;
    }
    
    .form-row label, .form-row .help, .help, label {
        color: #9fa6bc !important;
    }
    
    input, select, textarea {
        background-color: #0e1018 !important;
        border-color: #2a2e41 !important;
        color: #e3e6ed !important;
    }
    
    input:focus, select:focus, textarea:focus {
        border-color: #8ad0ff !important;
        background-color: #1c1e2d !important;
    }
    
    .submit-row {
        background-color: #1c1e2d !important;
        border-top: 1px solid #2a2e41 !important;
        padding: 1rem !important;
    }
    
    .submit-row input[type="submit"],
    .submit-row button[type="submit"] {
        background-color: #8ad0ff !important;
        border-color: #8ad0ff !important;
        color: #0b0d1a !important;
        font-weight: 600 !important;
        padding: 0.5rem 1.5rem !important;
        border-radius: 6px !important;
        transition: all 0.3s ease !important;
    }
    
    .submit-row input[type="submit"]:hover,
    .submit-row button[type="submit"]:hover {
        background-color: #6ec0f0 !important;
        border-color: #6ec0f0 !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(138, 208, 255, 0.3) !important;
    }
    
    .submit-row .deletelink,
    .submit-row .deletelink-box,
    .submit-row input[name="_delete"],
    .submit-row a.deletelink {
        background-color: #ff6b6b !important;
        border-color: #ff6b6b !important;
        color: #fff !important;
        padding: 0.5rem 1.5rem !important;
        border-radius: 6px !important;
        text-decoration: none !important;
        transition: all 0.3s ease !important;
    }
    
    .submit-row .deletelink:hover,
    .submit-row .deletelink-box:hover,
    .submit-row a.deletelink:hover {
        background-color: #ff5252 !important;
        border-color: #ff5252 !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(255, 107, 107, 0.3) !important;
    }
    
    .submit-row input[name="_continue"],
    .submit-row input[name="_addanother"] {
        background-color: #2a2e41 !important;
        border-color: #2a2e41 !important;
        color: #9fa6bc !important;
    }
    
    .submit-row input[name="_continue"]:hover,
    .submit-row input[name="_addanother"]:hover {
        background-color: #363c54 !important;
        border-color: #363c54 !important;
        color: #e3e6ed !important;
    }
    
    .breadcrumbs {
        background-color: #1c1e2d !important;
        border-bottom: 1px solid #2a2e41 !important;
        color: #9fa6bc !important;
    }
    
    .breadcrumbs a {
        color: #8ad0ff !important;
    }
    
    /* Card —Å—Ç–∏–ª–∏ */
    .card {
        box-shadow: 0 0 10px rgba(0,0,0,0.3) !important;
    }
    
    .card-header {
        background-color: #0e1018 !important;
        color: #e3e6ed !important;
        border-bottom: 1px solid #2a2e41 !important;
    }
    
    .card-header.bg-primary {
        background-color: #8ad0ff !important;
        color: #0b0d1a !important;
    }
    
    .card-body {
        background-color: #1c1e2d !important;
        color: #e3e6ed !important;
    }
    
    .text-muted {
        color: #6e7891 !important;
    }
    
    .list-group-item {
        background-color: #1c1e2d !important;
        border-color: #2a2e41 !important;
        color: #e3e6ed !important;
    }
    
    .balance-indicator {
        background-color: rgba(138, 208, 255, 0.1);
        border: 1px solid #8ad0ff;
        border-radius: 4px;
        padding: 1rem;
        text-align: center;
    }
    
    .balance-indicator h4 {
        color: #9fa6bc;
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }
    
    .balance-indicator h2 {
        color: #e3e6ed;
        font-size: 2rem;
        font-weight: 600;
    }
    
    .balance-indicator small {
        color: #6e7891;
    }
    
    /* –ö–Ω–æ–ø–∫–∏ */
    .btn {
        border-color: #2a2e41 !important;
    }
    
    .btn-outline-secondary {
        color: #9fa6bc !important;
        border-color: #2a2e41 !important;
        background-color: #1c1e2d !important;
    }
    
    .btn-outline-secondary:hover {
        background-color: #2a2e41 !important;
        color: #e3e6ed !important;
    }
    
    .btn-outline-primary {
        color: #8ad0ff !important;
        border-color: #8ad0ff !important;
        background-color: rgba(138, 208, 255, 0.1) !important;
    }
    
    .btn-outline-primary:hover {
        background-color: #8ad0ff !important;
        color: #0b0d1a !important;
    }
    
    /* Alert —Å—Ç–∏–ª–∏ */
    .alert-info {
        background-color: rgba(138, 208, 255, 0.1) !important;
        border-color: #8ad0ff !important;
        color: #e3e6ed !important;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ —á–µ–∫–±–æ–∫—Å–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –¥–æ–≥–æ–≤–æ—Ä–∞" */
    .rental-filter-compact {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background-color: rgba(138, 208, 255, 0.08) !important;
        border: 1px solid #2a2e41 !important;
        border-radius: 4px;
        padding: 0.4rem 0.75rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .rental-filter-compact:hover {
        background-color: rgba(138, 208, 255, 0.12) !important;
        border-color: #8ad0ff !important;
    }
    
    .rental-filter-compact input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
        margin: 0;
    }
    
    .rental-filter-compact span {
        color: #9fa6bc !important;
        font-size: 0.875rem;
        font-weight: 500;
        user-select: none;
    }
    
    .rental-status-badge {
        background-color: rgba(138, 208, 255, 0.15);
        color: #8ad0ff;
        padding: 0.15rem 0.5rem;
        font-size: 0.7rem;
        font-weight: 600;
        border-radius: 3px;
        margin-left: 0.5rem;
    }
    
    .rental-status-badge.active {
        background-color: rgba(0, 210, 122, 0.15);
        color: #00d27a;
    }
    
    .rental-status-badge.all {
        background-color: rgba(159, 166, 188, 0.15);
        color: #9fa6bc;
    }
    
    /* Select2 —Ç–µ–º–Ω–∞—è —Ç–µ–º–∞ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) */
    .select2-container--admin-autocomplete .select2-selection--single,
    .select2-container--admin-autocomplete .select2-selection--multiple {
        background-color: #0e1018 !important;
        border-color: #2a2e41 !important;
    }
    
    .select2-container--admin-autocomplete .select2-selection__rendered {
        color: #e3e6ed !important;
    }
    
    .select2-dropdown {
        background-color: #1c1e2d !important;
        border-color: #2a2e41 !important;
    }
    
    .select2-container--admin-autocomplete .select2-results__option {
        background-color: #1c1e2d !important;
        color: #e3e6ed !important;
    }
    
    .select2-container--admin-autocomplete .select2-results__option--highlighted {
        background-color: #2a2e41 !important;
        color: #8ad0ff !important;
    }
    
    .select2-search__field {
        background-color: #0e1018 !important;
        border-color: #2a2e41 !important;
        color: #e3e6ed !important;
    }
    
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
    @media (max-width: 768px) {
        .rental-filter-box {
            padding: 0.75rem;
        }
        
        .rental-filter-help {
            margin-left: 0;
        }
    }
  </style>
{% endblock %}

{% block field_sets %}
  <!-- –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤ (–±—É–¥–µ—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω —á–µ—Ä–µ–∑ JS) -->
  <div id="rental-filter-compact-wrapper" style="display: none;">
    <label class="rental-filter-compact">
      <input 
        type="checkbox" 
        id="show_all_rentals_checkbox"
        {% if show_all_rentals %}checked{% endif %}
      >
      <span>–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –¥–æ–≥–æ–≤–æ—Ä–∞</span>
      {% if not show_all_rentals %}
        <span class="rental-status-badge active">–¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ</span>
      {% else %}
        <span class="rental-status-badge all">–í—Å–µ</span>
      {% endif %}
    </label>
  </div>

  <!-- AJAX-–∫–∞—Ä—Ç–æ—á–∫–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –¥–æ–≥–æ–≤–æ—Ä–µ -->
  <div id="rental-info-card" class="card mb-3" style="display:none;">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–≥–æ–≤–æ—Ä–µ</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <p class="mb-2"><strong>–ö–ª–∏–µ–Ω—Ç:</strong> <span id="client-name" class="text-muted">-</span></p>
          <p class="mb-2"><strong>–î–æ–≥–æ–≤–æ—Ä:</strong> <span id="contract-code" class="text-muted">-</span></p>
          <p class="mb-2"><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="rental-status" class="badge bg-secondary">-</span></p>
          <p class="mb-2"><strong>–î–∞—Ç–∞ —Å—Ç–∞—Ä—Ç–∞:</strong> <span id="rental-start-date" class="text-muted">-</span></p>
          <p class="mb-2"><strong>üîã –ë–∞—Ç–∞—Ä–µ–∏:</strong> <span id="battery-numbers" class="text-muted">-</span></p>
        </div>
        <div class="col-md-6">
          <div class="balance-indicator">
            <h4>–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</h4>
            <h2 id="current-balance" class="mb-1">0.00 PLN</h2>
            <small style="opacity: 0.9;">
              –î–æ–ª–∂–µ–Ω: <span id="charges">0.00</span> PLN | 
              –û–ø–ª–∞—á–µ–Ω–æ: <span id="paid">0.00</span> PLN
            </small>
          </div>
        </div>
      </div>
      
      <hr class="my-3">
      
      <div class="row">
        <div class="col-12">
          <h6>üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏:</h6>
          <ul id="recent-payments" class="list-group list-group-flush">
            <li class="list-group-item text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–≥–æ–≤–æ—Ä –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏...</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ç–∏–ø–∏—á–Ω—ã—Ö —Å—É–º–º -->
  <div class="card mb-3">
    <div class="card-body">
      <h6 class="card-title">‚ö° –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä —Å—É–º–º—ã</h6>
      <div class="quick-amounts btn-group-sm" role="group">
        <button type="button" class="btn btn-outline-secondary" data-amount="80">80 PLN</button>
        <button type="button" class="btn btn-outline-secondary" data-amount="90">90 PLN</button>
        <button type="button" class="btn btn-outline-secondary" data-amount="100">100 PLN</button>
        <button type="button" class="btn btn-outline-secondary" data-amount="110">110 PLN</button>
        <button type="button" class="btn btn-outline-secondary" data-amount="160">160 PLN</button>
        <button type="button" class="btn btn-outline-secondary" data-amount="180">180 PLN</button>
        <button type="button" class="btn btn-outline-secondary" data-amount="200">200 PLN</button>
        <button type="button" class="btn btn-outline-secondary" data-amount="220">220 PLN</button>
        <button type="button" class="btn btn-outline-primary" id="fill-debt" style="display:none;">üí∞ –ü–æ–≥–∞—Å–∏—Ç—å –¥–æ–ª–≥</button>
      </div>
    </div>
  </div>

  <!-- Preview –Ω–æ–≤–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ -->
  <div class="alert alert-info" id="balance-preview" style="display:none;">
    <strong>üìä –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä:</strong>
    <p class="mb-0">–ü–æ—Å–ª–µ –ø–ª–∞—Ç–µ–∂–∞ –±–∞–ª–∞–Ω—Å —Å—Ç–∞–Ω–µ—Ç: <strong id="new-balance" class="fs-5">0.00 PLN</strong></p>
  </div>

  {{ block.super }}
{% endblock %}

{% block after_field_sets %}
  {{ block.super }}
{% endblock %}

{% block extrahead %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —á–µ–∫–±–æ–∫—Å –≤ –Ω–∞—á–∞–ª–æ –±–ª–æ–∫–∞ "–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è"
      const filterWrapper = document.getElementById('rental-filter-compact-wrapper');
      const firstFieldset = document.querySelector('fieldset.module');
      
      if (filterWrapper && firstFieldset) {
        // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤–Ω—É—Ç—Ä–∏ fieldset (–ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ h2)
        const firstFieldsetH2 = firstFieldset.querySelector('h2');
        if (firstFieldsetH2) {
          // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
          firstFieldsetH2.insertAdjacentElement('afterend', filterWrapper);
          filterWrapper.style.display = 'block';
          filterWrapper.style.marginTop = '0.75rem';
          filterWrapper.style.marginBottom = '0.75rem';
          filterWrapper.style.marginLeft = '1rem';
        }
      }
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —á–µ–∫–±–æ–∫—Å–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –¥–æ–≥–æ–≤–æ—Ä–∞"
      const showAllCheckbox = document.getElementById('show_all_rentals_checkbox');
      if (showAllCheckbox) {
        showAllCheckbox.addEventListener('change', function() {
          const isChecked = this.checked;
          const currentUrl = new URL(window.location.href);
          
          if (isChecked) {
            currentUrl.searchParams.set('show_all_rentals', '1');
          } else {
            currentUrl.searchParams.delete('show_all_rentals');
          }
          
          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –Ω–æ–≤—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
          window.location.href = currentUrl.toString();
        });
      }
      
      const rentalField = document.getElementById('id_rental');
      const amountField = document.getElementById('id_amount');
      const typeField = document.getElementById('id_type');
      const rentalInfoCard = document.getElementById('rental-info-card');
      const balancePreview = document.getElementById('balance-preview');
      const fillDebtBtn = document.getElementById('fill-debt');
      
      let currentBalance = 0;
      let currentCharges = 0;
      
      // –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Å—É–º–º
      document.querySelectorAll('[data-amount]').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          amountField.value = this.dataset.amount;
          updateBalancePreview();
        });
      });
      
      // –ö–Ω–æ–ø–∫–∞ "–ü–æ–≥–∞—Å–∏—Ç—å –¥–æ–ª–≥"
      if (fillDebtBtn) {
        fillDebtBtn.addEventListener('click', function(e) {
          e.preventDefault();
          if (currentBalance > 0) {
            amountField.value = currentBalance.toFixed(2);
            updateBalancePreview();
          }
        });
      }
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ preview –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—É–º–º—ã
      if (amountField) {
        amountField.addEventListener('input', updateBalancePreview);
      }
      
      // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∏–ø–∞ –ø–ª–∞—Ç–µ–∂–∞ —Ç–∞–∫–∂–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –±–∞–ª–∞–Ω—Å
      if (typeField) {
        typeField.addEventListener('change', updateBalancePreview);
      }
      
      function updateBalancePreview() {
        if (!amountField || !balancePreview) return;
        
        const paymentAmount = parseFloat(amountField.value) || 0;
        const paymentType = typeField ? typeField.value : 'rent';
        
        let newBalance = currentBalance;
        
        // –†–∞—Å—á–µ—Ç –Ω–æ–≤–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
        if (paymentType === 'rent' || paymentType === 'sold') {
          newBalance = currentBalance - paymentAmount;
        } else if (paymentType === 'deposit') {
          // –î–µ–ø–æ–∑–∏—Ç –Ω–µ –º–µ–Ω—è–µ—Ç –±–∞–ª–∞–Ω—Å –∞—Ä–µ–Ω–¥—ã
          newBalance = currentBalance;
        } else if (paymentType === 'return_deposit') {
          // –í–æ–∑–≤—Ä–∞—Ç –¥–µ–ø–æ–∑–∏—Ç–∞ —Ç–æ–∂–µ –Ω–µ –º–µ–Ω—è–µ—Ç –±–∞–ª–∞–Ω—Å –∞—Ä–µ–Ω–¥—ã
          newBalance = currentBalance;
        } else if (paymentType === 'adjustment') {
          newBalance = currentBalance - paymentAmount;
        }
        
        const newBalanceElem = document.getElementById('new-balance');
        if (newBalanceElem) {
          // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∑–Ω–∞–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
          const displayNewBalance = -newBalance;
          newBalanceElem.textContent = (displayNewBalance >= 0 ? '+' : '') + displayNewBalance.toFixed(2) + ' PLN';
          newBalanceElem.className = 'fs-5 ' + (displayNewBalance < 0 ? 'text-danger' : 'text-success');
        }
        
        if (paymentAmount > 0) {
          balancePreview.style.display = 'block';
        } else {
          balancePreview.style.display = 'none';
        }
      }
      
      // AJAX –∑–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–æ–≥–æ–≤–æ—Ä–µ
      if (rentalField) {
        rentalField.addEventListener('change', function() {
          const rentalId = this.value;
          
          if (!rentalId) {
            rentalInfoCard.style.display = 'none';
            return;
          }
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Å–æ —Å–ø–∏–Ω–Ω–µ—Ä–æ–º
          rentalInfoCard.style.display = 'block';
          document.getElementById('recent-payments').innerHTML = '<li class="list-group-item"><span class="loading-spinner me-2"></span>–ó–∞–≥—Ä—É–∑–∫–∞...</li>';
          
          // AJAX –∑–∞–ø—Ä–æ—Å
          fetch(`/admin/rental/payment/get-rental-info/?rental_id=${rentalId}`, {
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('AJAX Response:', data);
            if (data.success) {
              // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
              document.getElementById('client-name').textContent = data.client_name || '-';
              document.getElementById('contract-code').textContent = data.contract_code || '-';
              
              const statusBadge = document.getElementById('rental-status');
              statusBadge.textContent = data.status_display || '-';
              statusBadge.className = 'badge bg-' + (data.status === 'active' ? 'success' : 'secondary');
              
              // –î–∞—Ç–∞ —Å—Ç–∞—Ä—Ç–∞ (–æ—Ç –ø–µ—Ä–≤–æ–π –≤–µ—Ä—Å–∏–∏)
              document.getElementById('rental-start-date').textContent = data.start_date || '-';
              
              // –ù–æ–º–µ—Ä–∞ –±–∞—Ç–∞—Ä–µ–π
              const batteryNumbers = data.battery_numbers || [];
              const batteryElem = document.getElementById('battery-numbers');
              if (batteryNumbers.length > 0) {
                batteryElem.innerHTML = batteryNumbers.map(num => 
                  `<span class="badge bg-info text-dark me-1">${num}</span>`
                ).join('');
              } else {
                batteryElem.textContent = '-';
              }
              
              // –ë–∞–ª–∞–Ω—Å
              const balance = parseFloat(data.balance) || 0;
              const charges = parseFloat(data.charges) || 0;
              const paid = parseFloat(data.paid) || 0;
              
              currentBalance = balance;
              currentCharges = charges;
              
              // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∑–Ω–∞–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å = –∫–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω (–∫—Ä–∞—Å–Ω—ã–π)
              const displayBalance = -balance;
              
              const balanceElem = document.getElementById('current-balance');
              balanceElem.textContent = (displayBalance >= 0 ? '+' : '') + displayBalance.toFixed(2) + ' PLN';
              balanceElem.className = displayBalance < 0 ? 'mb-1 text-danger' : 'mb-1 text-success';
              
              document.getElementById('charges').textContent = charges.toFixed(2);
              document.getElementById('paid').textContent = paid.toFixed(2);
              
              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–≥–∞—Å–∏—Ç—å –¥–æ–ª–≥"
              if (balance > 0 && fillDebtBtn) {
                fillDebtBtn.style.display = 'inline-block';
                fillDebtBtn.dataset.amount = balance.toFixed(2);
              } else if (fillDebtBtn) {
                fillDebtBtn.style.display = 'none';
              }
              
              // –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏
              const recentPaymentsList = document.getElementById('recent-payments');
              if (data.recent_payments && data.recent_payments.length > 0) {
                recentPaymentsList.innerHTML = data.recent_payments.map(p => `
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <small class="text-muted">${p.date}</small>
                      <span class="ms-2">${p.type_display}</span>
                    </div>
                    <strong>${p.amount} PLN</strong>
                  </li>
                `).join('');
              } else {
                recentPaymentsList.innerHTML = '<li class="list-group-item text-muted">–ü–ª–∞—Ç–µ–∂–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</li>';
              }
              
              updateBalancePreview();
            } else {
              rentalInfoCard.style.display = 'none';
              console.error('Error loading rental info:', data);
              
              let errorMsg = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–∞:\n\n';
              errorMsg += '–¢–∏–ø –æ—à–∏–±–∫–∏: ' + (data.error_type || 'Unknown') + '\n';
              errorMsg += '–°–æ–æ–±—â–µ–Ω–∏–µ: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '\n';
              
              if (data.traceback) {
                errorMsg += '\n--- Traceback (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏) ---\n' + data.traceback;
                console.error('Server Traceback:', data.traceback);
              }
              
              alert(errorMsg);
              
              document.getElementById('recent-payments').innerHTML = 
                '<li class="list-group-item text-danger"><strong>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</strong><br>' +
                '<small>–¢–∏–ø: ' + (data.error_type || 'Unknown') + '</small><br>' +
                '<small>' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</small></li>';
            }
          })
          .catch(error => {
            console.error('AJAX Error:', error);
            const errorMsg = error.message || error.toString();
            
            document.getElementById('recent-payments').innerHTML = 
              '<li class="list-group-item text-danger"><strong>–û—à–∏–±–∫–∞ —Å–µ—Ç–∏/—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</strong><br>' +
              '<small>' + errorMsg + '</small></li>';
            
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–æ–≥–æ–≤–æ—Ä–µ:\n\n' + 
                  '–¢–∏–ø: Network/Connection Error\n' +
                  '–°–æ–æ–±—â–µ–Ω–∏–µ: ' + errorMsg + '\n\n' +
                  '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n' +
                  '1. –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º\n' +
                  '2. –ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π\n' +
                  '3. –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞');
          });
        });
        
        // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–ª–∞—Ç–µ–∂, –∑–∞–≥—Ä—É–∑–∏–º –¥–∞–Ω–Ω—ã–µ
        if (rentalField.value) {
          rentalField.dispatchEvent(new Event('change'));
        }
      }
      
      // Initialize Bootstrap tooltips
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });
    });
  </script>
{% endblock %}

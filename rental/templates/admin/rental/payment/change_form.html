{% extends "admin/change_form.html" %}
{% load static %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'admin/css/custom.css' %}">
{% endblock %}

{% block field_sets %}
  <!-- AJAX-–∫–∞—Ä—Ç–æ—á–∫–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –¥–æ–≥–æ–≤–æ—Ä–µ -->
  <div id="rental-info-card" class="card mb-3" style="display:none;">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–≥–æ–≤–æ—Ä–µ</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <p class="mb-2"><strong>–ö–ª–∏–µ–Ω—Ç:</strong> <span id="client-name" class="text-muted">-</span></p>
          <p class="mb-2"><strong>–î–æ–≥–æ–≤–æ—Ä:</strong> <span id="contract-code" class="text-muted">-</span></p>
          <p class="mb-2"><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="rental-status" class="badge bg-secondary">-</span></p>
        </div>
        <div class="col-md-6">
          <div class="balance-indicator">
            <h4>–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</h4>
            <h2 id="current-balance" class="mb-1">0.00 PLN</h2>
            <small style="opacity: 0.9;">
              –î–æ–ª–∂–µ–Ω: <span id="charges">0.00</span> PLN | 
              –û–ø–ª–∞—á–µ–Ω–æ: <span id="paid">0.00</span> PLN
            </small>
          </div>
        </div>
      </div>
      
      <hr class="my-3">
      
      <div class="row">
        <div class="col-12">
          <h6>üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏:</h6>
          <ul id="recent-payments" class="list-group list-group-flush">
            <li class="list-group-item text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–≥–æ–≤–æ—Ä –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏...</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ç–∏–ø–∏—á–Ω—ã—Ö —Å—É–º–º -->
  <div class="card mb-3">
    <div class="card-body">
      <h6 class="card-title">‚ö° –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä —Å—É–º–º—ã</h6>
      <div class="quick-amounts btn-group-sm" role="group">
        <button type="button" class="btn btn-outline-secondary" data-amount="80">80 PLN</button>
        <button type="button" class="btn btn-outline-secondary" data-amount="90">90 PLN</button>
        <button type="button" class="btn btn-outline-secondary" data-amount="100">100 PLN</button>
        <button type="button" class="btn btn-outline-secondary" data-amount="110">110 PLN</button>
        <button type="button" class="btn btn-outline-secondary" data-amount="160">160 PLN</button>
        <button type="button" class="btn btn-outline-secondary" data-amount="180">180 PLN</button>
        <button type="button" class="btn btn-outline-secondary" data-amount="200">200 PLN</button>
        <button type="button" class="btn btn-outline-secondary" data-amount="220">220 PLN</button>
        <button type="button" class="btn btn-outline-primary" id="fill-debt" style="display:none;">üí∞ –ü–æ–≥–∞—Å–∏—Ç—å –¥–æ–ª–≥</button>
      </div>
    </div>
  </div>

  <!-- Preview –Ω–æ–≤–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ -->
  <div class="alert alert-info" id="balance-preview" style="display:none;">
    <strong>üìä –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä:</strong>
    <p class="mb-0">–ü–æ—Å–ª–µ –ø–ª–∞—Ç–µ–∂–∞ –±–∞–ª–∞–Ω—Å —Å—Ç–∞–Ω–µ—Ç: <strong id="new-balance" class="fs-5">0.00 PLN</strong></p>
  </div>

  {{ block.super }}
{% endblock %}

{% block after_field_sets %}
  {{ block.super }}
{% endblock %}

{% block extrahead %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const rentalField = document.getElementById('id_rental');
      const amountField = document.getElementById('id_amount');
      const typeField = document.getElementById('id_type');
      const rentalInfoCard = document.getElementById('rental-info-card');
      const balancePreview = document.getElementById('balance-preview');
      const fillDebtBtn = document.getElementById('fill-debt');
      
      let currentBalance = 0;
      let currentCharges = 0;
      
      // –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Å—É–º–º
      document.querySelectorAll('[data-amount]').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          amountField.value = this.dataset.amount;
          updateBalancePreview();
        });
      });
      
      // –ö–Ω–æ–ø–∫–∞ "–ü–æ–≥–∞—Å–∏—Ç—å –¥–æ–ª–≥"
      if (fillDebtBtn) {
        fillDebtBtn.addEventListener('click', function(e) {
          e.preventDefault();
          if (currentBalance > 0) {
            amountField.value = currentBalance.toFixed(2);
            updateBalancePreview();
          }
        });
      }
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ preview –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—É–º–º—ã
      if (amountField) {
        amountField.addEventListener('input', updateBalancePreview);
      }
      
      // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∏–ø–∞ –ø–ª–∞—Ç–µ–∂–∞ —Ç–∞–∫–∂–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –±–∞–ª–∞–Ω—Å
      if (typeField) {
        typeField.addEventListener('change', updateBalancePreview);
      }
      
      function updateBalancePreview() {
        if (!amountField || !balancePreview) return;
        
        const paymentAmount = parseFloat(amountField.value) || 0;
        const paymentType = typeField ? typeField.value : 'rent';
        
        let newBalance = currentBalance;
        
        // –†–∞—Å—á–µ—Ç –Ω–æ–≤–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
        if (paymentType === 'rent' || paymentType === 'sold') {
          newBalance = currentBalance - paymentAmount;
        } else if (paymentType === 'deposit') {
          // –î–µ–ø–æ–∑–∏—Ç –Ω–µ –º–µ–Ω—è–µ—Ç –±–∞–ª–∞–Ω—Å –∞—Ä–µ–Ω–¥—ã
          newBalance = currentBalance;
        } else if (paymentType === 'return_deposit') {
          // –í–æ–∑–≤—Ä–∞—Ç –¥–µ–ø–æ–∑–∏—Ç–∞ —Ç–æ–∂–µ –Ω–µ –º–µ–Ω—è–µ—Ç –±–∞–ª–∞–Ω—Å –∞—Ä–µ–Ω–¥—ã
          newBalance = currentBalance;
        } else if (paymentType === 'adjustment') {
          newBalance = currentBalance - paymentAmount;
        }
        
        const newBalanceElem = document.getElementById('new-balance');
        if (newBalanceElem) {
          // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∑–Ω–∞–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
          const displayNewBalance = -newBalance;
          newBalanceElem.textContent = (displayNewBalance >= 0 ? '+' : '') + displayNewBalance.toFixed(2) + ' PLN';
          newBalanceElem.className = 'fs-5 ' + (displayNewBalance < 0 ? 'text-danger' : 'text-success');
        }
        
        if (paymentAmount > 0) {
          balancePreview.style.display = 'block';
        } else {
          balancePreview.style.display = 'none';
        }
      }
      
      // AJAX –∑–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–æ–≥–æ–≤–æ—Ä–µ
      if (rentalField) {
        rentalField.addEventListener('change', function() {
          const rentalId = this.value;
          
          if (!rentalId) {
            rentalInfoCard.style.display = 'none';
            return;
          }
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Å–æ —Å–ø–∏–Ω–Ω–µ—Ä–æ–º
          rentalInfoCard.style.display = 'block';
          document.getElementById('recent-payments').innerHTML = '<li class="list-group-item"><span class="loading-spinner me-2"></span>–ó–∞–≥—Ä—É–∑–∫–∞...</li>';
          
          // AJAX –∑–∞–ø—Ä–æ—Å
          fetch(`/admin/rental/payment/get-rental-info/?rental_id=${rentalId}`, {
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('AJAX Response:', data);
            if (data.success) {
              // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
              document.getElementById('client-name').textContent = data.client_name || '-';
              document.getElementById('contract-code').textContent = data.contract_code || '-';
              
              const statusBadge = document.getElementById('rental-status');
              statusBadge.textContent = data.status_display || '-';
              statusBadge.className = 'badge bg-' + (data.status === 'active' ? 'success' : 'secondary');
              
              // –ë–∞–ª–∞–Ω—Å
              const balance = parseFloat(data.balance) || 0;
              const charges = parseFloat(data.charges) || 0;
              const paid = parseFloat(data.paid) || 0;
              
              currentBalance = balance;
              currentCharges = charges;
              
              // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∑–Ω–∞–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å = –∫–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω (–∫—Ä–∞—Å–Ω—ã–π)
              const displayBalance = -balance;
              
              const balanceElem = document.getElementById('current-balance');
              balanceElem.textContent = (displayBalance >= 0 ? '+' : '') + displayBalance.toFixed(2) + ' PLN';
              balanceElem.className = displayBalance < 0 ? 'mb-1 text-danger' : 'mb-1 text-success';
              
              document.getElementById('charges').textContent = charges.toFixed(2);
              document.getElementById('paid').textContent = paid.toFixed(2);
              
              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–≥–∞—Å–∏—Ç—å –¥–æ–ª–≥"
              if (balance > 0 && fillDebtBtn) {
                fillDebtBtn.style.display = 'inline-block';
                fillDebtBtn.dataset.amount = balance.toFixed(2);
              } else if (fillDebtBtn) {
                fillDebtBtn.style.display = 'none';
              }
              
              // –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏
              const recentPaymentsList = document.getElementById('recent-payments');
              if (data.recent_payments && data.recent_payments.length > 0) {
                recentPaymentsList.innerHTML = data.recent_payments.map(p => `
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <small class="text-muted">${p.date}</small>
                      <span class="ms-2">${p.type_display}</span>
                    </div>
                    <strong>${p.amount} PLN</strong>
                  </li>
                `).join('');
              } else {
                recentPaymentsList.innerHTML = '<li class="list-group-item text-muted">–ü–ª–∞—Ç–µ–∂–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</li>';
              }
              
              updateBalancePreview();
            } else {
              rentalInfoCard.style.display = 'none';
              console.error('Error loading rental info:', data);
              
              let errorMsg = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–∞:\n\n';
              errorMsg += '–¢–∏–ø –æ—à–∏–±–∫–∏: ' + (data.error_type || 'Unknown') + '\n';
              errorMsg += '–°–æ–æ–±—â–µ–Ω–∏–µ: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '\n';
              
              if (data.traceback) {
                errorMsg += '\n--- Traceback (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏) ---\n' + data.traceback;
                console.error('Server Traceback:', data.traceback);
              }
              
              alert(errorMsg);
              
              document.getElementById('recent-payments').innerHTML = 
                '<li class="list-group-item text-danger"><strong>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</strong><br>' +
                '<small>–¢–∏–ø: ' + (data.error_type || 'Unknown') + '</small><br>' +
                '<small>' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</small></li>';
            }
          })
          .catch(error => {
            console.error('AJAX Error:', error);
            const errorMsg = error.message || error.toString();
            
            document.getElementById('recent-payments').innerHTML = 
              '<li class="list-group-item text-danger"><strong>–û—à–∏–±–∫–∞ —Å–µ—Ç–∏/—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</strong><br>' +
              '<small>' + errorMsg + '</small></li>';
            
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–æ–≥–æ–≤–æ—Ä–µ:\n\n' + 
                  '–¢–∏–ø: Network/Connection Error\n' +
                  '–°–æ–æ–±—â–µ–Ω–∏–µ: ' + errorMsg + '\n\n' +
                  '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n' +
                  '1. –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º\n' +
                  '2. –ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π\n' +
                  '3. –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞');
          });
        });
        
        // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–ª–∞—Ç–µ–∂, –∑–∞–≥—Ä—É–∑–∏–º –¥–∞–Ω–Ω—ã–µ
        if (rentalField.value) {
          rentalField.dispatchEvent(new Event('change'));
        }
      }
      
      // Initialize Bootstrap tooltips
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });
    });
  </script>
{% endblock %}

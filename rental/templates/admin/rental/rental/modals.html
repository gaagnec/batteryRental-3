{% load static %}

<!-- Close Rental Modal -->
<div class="modal fade" id="closeRentalModal" tabindex="-1" aria-labelledby="closeRentalModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="closeRentalModalLabel">
          <i class="bi bi-x-circle me-2"></i>
          Закрыть договор
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="closeRentalForm">
          {% csrf_token %}
          <div class="mb-3">
            <label for="close_date" class="form-label">Дата и время закрытия</label>
            <input type="datetime-local" class="form-control" id="close_date" name="close_date" required>
            <div class="form-text" style="color: #9fa6bc;">По умолчанию установлены текущие дата и время</div>
          </div>
          <div class="alert alert-info" style="background-color: rgba(102, 126, 234, 0.1); border-color: #667eea; color: #e9ecef;">
            <i class="bi bi-info-circle me-2"></i>
            <small>При закрытии договора будет установлено время завершения аренды всех батарей.</small>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-danger" onclick="submitCloseRental()">
          <i class="bi bi-check-circle me-1"></i>
          Закрыть договор
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Pause Rental Modal -->
<div class="modal fade" id="pauseRentalModal" tabindex="-1" aria-labelledby="pauseRentalModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="pauseRentalModalLabel">
          <i class="bi bi-pause-circle me-2"></i>
          Пауза договора
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="pauseRentalForm">
          {% csrf_token %}
          <div class="mb-3">
            <label for="pause_days" class="form-label">Количество дней паузы</label>
            <input type="number" class="form-control" id="pause_days" name="pause_days" min="1" max="365" required>
            <div class="form-text" style="color: #9fa6bc;">Укажите количество бесплатных дней</div>
          </div>
          <div class="mb-3">
            <label for="pause_start_date" class="form-label">Дата начала паузы (опционально)</label>
            <input type="datetime-local" class="form-control" id="pause_start_date" name="pause_start_date">
            <div class="form-text" style="color: #9fa6bc;">Оставьте пустым для начала с текущего момента</div>
          </div>
          <div class="alert alert-info" style="background-color: rgba(102, 126, 234, 0.1); border-color: #667eea; color: #e9ecef;">
            <i class="bi bi-info-circle me-2"></i>
            <small>Будет создана новая версия договора с нулевой ставкой на указанное количество дней. После завершения паузы автоматически создастся новая версия с предыдущей ставкой.</small>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-warning" onclick="submitPauseRental()" style="color: #1a1c2e;">
          <i class="bi bi-check-circle me-1"></i>
          Создать паузу
        </button>
      </div>
    </div>
  </div>
</div>

<!-- New Tariff Modal -->
<div class="modal fade" id="newTariffModal" tabindex="-1" aria-labelledby="newTariffModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newTariffModalLabel">
          <i class="bi bi-cash-coin me-2"></i>
          Новый тариф
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="newTariffForm">
          {% csrf_token %}
          <div class="mb-3">
            <label for="new_weekly_rate" class="form-label">Цена батареи в неделю (PLN)</label>
            <input type="number" class="form-control" id="new_weekly_rate" name="new_weekly_rate" step="0.01" min="0" required>
            <div class="form-text" style="color: #9fa6bc;">Укажите новую недельную ставку</div>
          </div>
          <div class="mb-3">
            <label for="tariff_start_date" class="form-label">Дата начала нового тарифа</label>
            <input type="datetime-local" class="form-control" id="tariff_start_date" name="tariff_start_date" required>
            <div class="form-text" style="color: #9fa6bc;">По умолчанию установлена текущая дата</div>
          </div>
          <div class="alert alert-info" style="background-color: rgba(102, 126, 234, 0.1); border-color: #667eea; color: #e9ecef;">
            <i class="bi bi-info-circle me-2"></i>
            <small>Будет создана новая версия договора с новым тарифом. Активные батареи будут перенесены в новую версию.</small>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn" style="background-color: #667eea; color: white;" onclick="submitNewTariff()">
          <i class="bi bi-check-circle me-1"></i>
          Создать новый тариф
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add Payment Modal -->
<div class="modal fade" id="addPaymentModal" tabindex="-1" aria-labelledby="addPaymentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addPaymentModalLabel">
          <i class="bi bi-plus-circle me-2"></i>
          Добавить платеж
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addPaymentForm">
          {% csrf_token %}
          <div class="mb-3">
            <label for="payment_amount" class="form-label">Сумма платежа (PLN)</label>
            <input type="number" class="form-control" id="payment_amount" name="payment_amount" step="0.01" required>
            <div class="form-text" style="color: #9fa6bc;">Укажите сумму платежа</div>
          </div>
          <div class="mb-3">
            <label for="payment_date" class="form-label">Дата платежа</label>
            <input type="date" class="form-control" id="payment_date" name="payment_date" required>
            <div class="form-text" style="color: #9fa6bc;">Дата получения платежа</div>
          </div>
          <div class="mb-3">
            <label for="payment_type" class="form-label">Тип платежа</label>
            <select class="form-control" id="payment_type" name="payment_type" required>
              <option value="rent">Аренда</option>
              <option value="deposit">Депозит</option>
              <option value="sold">Продажа</option>
              <option value="adjustment">Корректировка</option>
              <option value="return_deposit">Возврат депозита</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="payment_method" class="form-label">Метод оплаты</label>
            <select class="form-control" id="payment_method" name="payment_method" required>
              <option value="cash">Наличные</option>
              <option value="blik">BLIK</option>
              <option value="revolut">Revolut</option>
              <option value="other">Другое</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="payment_note" class="form-label">Примечание (опционально)</label>
            <textarea class="form-control" id="payment_note" name="payment_note" rows="2"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-success" onclick="submitAddPayment()">
          <i class="bi bi-check-circle me-1"></i>
          Добавить платеж
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Change Batteries Modal -->
<div class="modal fade" id="changeBatteriesModal" tabindex="-1" aria-labelledby="changeBatteriesModalLabel" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="changeBatteriesModalLabel">
          <i class="bi bi-battery-charging me-2"></i>
          Изменить батареи
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="changeBatteriesLoading" class="text-center py-4" style="color: #9fa6bc;">
          <div class="spinner-border" role="status"></div>
          <p class="mt-2 mb-0">Загрузка...</p>
        </div>
        <div id="changeBatteriesContent" style="display: none;">
          <p class="small text-secondary mb-3">Договор: <strong id="changeBatteriesContractCode"></strong></p>
          <h6 class="mb-2" style="color: #e9ecef;">Текущие назначения</h6>
          <div class="table-responsive mb-4">
            <table class="table table-dark table-sm phoenix-table">
              <thead>
                <tr>
                  <th>Батарея</th>
                  <th>Начало</th>
                  <th>Окончание</th>
                  <th>Действия</th>
                </tr>
              </thead>
              <tbody id="changeBatteriesAssignmentsTbody">
              </tbody>
            </table>
          </div>
          <div class="mb-3">
            <h6 class="mb-2" style="color: #e9ecef;">Добавить батарею</h6>
            <div class="d-flex flex-wrap gap-2 align-items-end">
              <div>
                <label class="form-label small mb-0" style="color: #9fa6bc;">Батарея</label>
                <select class="form-select form-select-sm" id="changeBatteriesAddSelect" style="min-width: 140px;">
                  <option value="">— выбрать —</option>
                </select>
              </div>
              <div>
                <label class="form-label small mb-0" style="color: #9fa6bc;">С даты</label>
                <input type="date" class="form-control form-control-sm" id="changeBatteriesAddStart">
              </div>
              <button type="button" class="btn btn-sm btn-success" id="changeBatteriesAddBtn">
                <i class="bi bi-plus"></i> Добавить
              </button>
            </div>
          </div>
          <div id="changeBatteriesEndForm" class="mb-3 p-3 rounded" style="display: none; background: #0e1018; border: 1px solid #2a2e41;">
            <p class="mb-2 small" style="color: #e9ecef;">Завершить назначение батареи <strong id="endBatteryCode"></strong></p>
            <div class="d-flex flex-wrap gap-2 align-items-end">
              <div>
                <label class="form-label small mb-0" style="color: #9fa6bc;">Дата окончания</label>
                <input type="date" class="form-control form-control-sm" id="endAssignmentDate">
              </div>
              <div>
                <label class="form-label small mb-0" style="color: #9fa6bc;">Причина</label>
                <input type="text" class="form-control form-control-sm" id="endAssignmentReason" placeholder="Необязательно" style="min-width: 160px;">
              </div>
              <button type="button" class="btn btn-sm btn-warning" id="endApplyBtn">Применить</button>
              <button type="button" class="btn btn-sm btn-secondary" id="endCancelBtn">Отмена</button>
            </div>
          </div>
          <div id="changeBatteriesReplaceForm" class="mb-3 p-3 rounded" style="display: none; background: #0e1018; border: 1px solid #2a2e41;">
            <p class="mb-2 small" style="color: #e9ecef;">Заменить батарею <strong id="replaceOldCode"></strong> на:</p>
            <div class="d-flex flex-wrap gap-2 align-items-end">
              <div>
                <label class="form-label small mb-0" style="color: #9fa6bc;">Новая батарея</label>
                <select class="form-select form-select-sm" id="replaceNewBatterySelect" style="min-width: 140px;"></select>
              </div>
              <div>
                <label class="form-label small mb-0" style="color: #9fa6bc;">С даты</label>
                <input type="date" class="form-control form-control-sm" id="replaceDate">
              </div>
              <div>
                <label class="form-label small mb-0" style="color: #9fa6bc;">Причина</label>
                <input type="text" class="form-control form-control-sm" id="replaceReason" placeholder="Замена батареи" style="min-width: 160px;">
              </div>
              <button type="button" class="btn btn-sm btn-info" id="replaceApplyBtn">Применить замену</button>
              <button type="button" class="btn btn-sm btn-secondary" id="replaceCancelBtn">Отмена</button>
            </div>
          </div>
          <div id="changeBatteriesPendingBlock" style="display: none;">
            <h6 class="mb-2" style="color: #e9ecef;">Запланированные изменения</h6>
            <ul id="changeBatteriesPendingList" class="list-group list-group-flush mb-3" style="background: transparent; color: #e9ecef;"></ul>
            <button type="button" class="btn btn-primary" id="changeBatteriesSubmitBtn">
              <i class="bi bi-check-circle me-1"></i> Сохранить изменения
            </button>
          </div>
        </div>
        <div id="changeBatteriesError" style="display: none; color: #dc3545;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Notification Toast -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
  <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header" style="background-color: #0e1018; border-bottom: 1px solid #2a2e41;">
      <i class="bi bi-check-circle text-success me-2" id="toastIcon"></i>
      <strong class="me-auto" id="toastTitle" style="color: #e9ecef;">Успешно</strong>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="toastBody" style="background-color: #1c1e2d; color: #e9ecef;">
      Операция выполнена успешно
    </div>
  </div>
</div>

<script>
  // Set current date/time for datetime inputs
  document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    const localDate = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 10);
    
    document.getElementById('close_date').value = localDateTime;
    document.getElementById('tariff_start_date').value = localDateTime;
    document.getElementById('payment_date').value = localDate;
  });

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function showNotification(title, message, isSuccess = true) {
    const toast = new bootstrap.Toast(document.getElementById('notificationToast'));
    const icon = document.getElementById('toastIcon');
    icon.className = isSuccess ? 'bi bi-check-circle text-success me-2' : 'bi bi-x-circle text-danger me-2';
    document.getElementById('toastTitle').textContent = title;
    document.getElementById('toastBody').textContent = message;
    toast.show();
  }

  function submitCloseRental() {
    const form = document.getElementById('closeRentalForm');
    const formData = new FormData(form);
    const rentalId = {{ original.id }};
    
    fetch(`/admin/rental/rental/${rentalId}/close/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification('Успешно', 'Договор закрыт');
        setTimeout(() => window.location.reload(), 1500);
      } else {
        showNotification('Ошибка', data.error || 'Не удалось закрыть договор', false);
      }
    })
    .catch(error => {
      showNotification('Ошибка', 'Произошла ошибка при выполнении операции', false);
      console.error('Error:', error);
    });
    
    bootstrap.Modal.getInstance(document.getElementById('closeRentalModal')).hide();
  }

  function submitPauseRental() {
    const form = document.getElementById('pauseRentalForm');
    const formData = new FormData(form);
    const rentalId = {{ original.id }};
    
    fetch(`/admin/rental/rental/${rentalId}/pause/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification('Успешно', 'Пауза создана');
        setTimeout(() => window.location.reload(), 1500);
      } else {
        showNotification('Ошибка', data.error || 'Не удалось создать паузу', false);
      }
    })
    .catch(error => {
      showNotification('Ошибка', 'Произошла ошибка при выполнении операции', false);
      console.error('Error:', error);
    });
    
    bootstrap.Modal.getInstance(document.getElementById('pauseRentalModal')).hide();
  }

  function submitNewTariff() {
    const form = document.getElementById('newTariffForm');
    const formData = new FormData(form);
    const rentalId = {{ original.id }};
    
    fetch(`/admin/rental/rental/${rentalId}/new-tariff/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification('Успешно', 'Новый тариф создан');
        setTimeout(() => window.location.href = data.redirect_url || window.location.href, 1500);
      } else {
        showNotification('Ошибка', data.error || 'Не удалось создать новый тариф', false);
      }
    })
    .catch(error => {
      showNotification('Ошибка', 'Произошла ошибка при выполнении операции', false);
      console.error('Error:', error);
    });
    
    bootstrap.Modal.getInstance(document.getElementById('newTariffModal')).hide();
  }

  function submitAddPayment() {
    const form = document.getElementById('addPaymentForm');
    const formData = new FormData(form);
    const rentalId = {{ original.id }};
    formData.append('rental_id', rentalId);
    
    fetch(`/admin/rental/rental/${rentalId}/add-payment/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification('Успешно', 'Платеж добавлен');
        setTimeout(() => window.location.reload(), 1500);
      } else {
        showNotification('Ошибка', data.error || 'Не удалось добавить платеж', false);
      }
    })
    .catch(error => {
      showNotification('Ошибка', 'Произошла ошибка при выполнении операции', false);
      console.error('Error:', error);
    });
    
    bootstrap.Modal.getInstance(document.getElementById('addPaymentModal')).hide();
  }

  // --- Change Batteries Modal ---
  const rentalIdForBatteries = {{ original.id }};
  let changeBatteriesData = { assignments: [], availableBatteries: [] };
  let changeBatteriesPendingActions = [];
  let replaceAssignmentId = null;
  let replaceOldCode = '';
  let endAssignmentId = null;
  let endBatteryCodeVal = '';

  function formatDateTime(iso) {
    if (!iso) return '—';
    const d = new Date(iso);
    return d.toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
  }
  function formatDateOnly(dateStr) {
    if (!dateStr) return '—';
    if (String(dateStr).length <= 10) return String(dateStr).split('-').reverse().join('.');
    return formatDateTime(dateStr);
  }

  function renderChangeBatteriesPending() {
    const list = document.getElementById('changeBatteriesPendingList');
    const block = document.getElementById('changeBatteriesPendingBlock');
    list.innerHTML = '';
    changeBatteriesPendingActions.forEach((act, idx) => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';
      li.style.backgroundColor = '#1c1e2d';
      li.style.borderColor = '#2a2e41';
      li.style.color = '#e9ecef';
      let text = '';
      if (act.type === 'end') text = 'Завершить: ' + (act.battery_short_code || '') + ' с ' + formatDateOnly(act.end_at);
      else if (act.type === 'replace') text = 'Заменить на ' + (act.new_battery_short_code || '') + ' с ' + formatDateOnly(act.date);
      else if (act.type === 'add') text = 'Добавить: ' + (act.battery_short_code || '') + ' с ' + formatDateOnly(act.start_at);
      li.innerHTML = '<span>' + text + '</span><button type="button" class="btn btn-sm btn-outline-danger" data-idx="' + idx + '"><i class="bi bi-x"></i></button>';
      li.querySelector('button').addEventListener('click', function() {
        changeBatteriesPendingActions.splice(parseInt(this.getAttribute('data-idx'), 10), 1);
        renderChangeBatteriesPending();
      });
      list.appendChild(li);
    });
    block.style.display = changeBatteriesPendingActions.length ? 'block' : 'none';
  }

  function loadChangeBatteriesModal() {
    document.getElementById('changeBatteriesLoading').style.display = 'block';
    document.getElementById('changeBatteriesContent').style.display = 'none';
    document.getElementById('changeBatteriesError').style.display = 'none';
    document.getElementById('changeBatteriesEndForm').style.display = 'none';
    document.getElementById('changeBatteriesReplaceForm').style.display = 'none';
    changeBatteriesPendingActions = [];

    Promise.all([
      fetch('/admin/rental/rental/' + rentalIdForBatteries + '/change-batteries/', {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      }).then(r => r.json()),
      fetch('/admin/rental/rental/' + rentalIdForBatteries + '/available-batteries/', {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      }).then(r => r.json())
    ]).then(([assignmentsResp, availableResp]) => {
      if (assignmentsResp.assignments === undefined && assignmentsResp.error) {
        document.getElementById('changeBatteriesError').textContent = assignmentsResp.error;
        document.getElementById('changeBatteriesError').style.display = 'block';
        document.getElementById('changeBatteriesLoading').style.display = 'none';
        return;
      }
      const assignments = assignmentsResp.assignments || [];
      const rental = assignmentsResp.rental || {};
      const batteries = availableResp.batteries || [];

      changeBatteriesData = { assignments, availableBatteries: batteries };

      document.getElementById('changeBatteriesContractCode').textContent = (rental.contract_code || '') + ' v' + (rental.version || '');

      const tbody = document.getElementById('changeBatteriesAssignmentsTbody');
      tbody.innerHTML = '';
      assignments.forEach(a => {
        const tr = document.createElement('tr');
        const endDisplay = a.end_at ? formatDateTime(a.end_at) : 'Активна';
        let actionsHtml = '';
        if (a.is_active) {
          actionsHtml = '<button type="button" class="btn btn-sm btn-outline-warning me-1 change-batteries-end-btn" data-id="' + a.id + '" data-code="' + (a.battery_short_code || '') + '">Завершить</button>' +
            '<button type="button" class="btn btn-sm btn-outline-info change-batteries-replace-btn" data-id="' + a.id + '" data-code="' + (a.battery_short_code || '') + '">Заменить</button>';
        } else {
          actionsHtml = '<span class="badge bg-secondary">Завершена</span>';
        }
        tr.innerHTML = '<td>' + (a.battery_short_code || '') + '</td><td>' + formatDateTime(a.start_at) + '</td><td>' + endDisplay + '</td><td>' + actionsHtml + '</td>';
        tbody.appendChild(tr);
      });

      const addSelect = document.getElementById('changeBatteriesAddSelect');
      addSelect.innerHTML = '<option value="">— выбрать —</option>';
      batteries.forEach(b => {
        addSelect.innerHTML += '<option value="' + b.id + '">' + b.short_code + '</option>';
      });

      const now = new Date();
      const localDate = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 10);
      document.getElementById('changeBatteriesAddStart').value = localDate;

      document.getElementById('changeBatteriesLoading').style.display = 'none';
      document.getElementById('changeBatteriesContent').style.display = 'block';

      document.querySelectorAll('.change-batteries-end-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          endAssignmentId = parseInt(this.getAttribute('data-id'), 10);
          endBatteryCodeVal = this.getAttribute('data-code') || '';
          document.getElementById('endBatteryCode').textContent = endBatteryCodeVal;
          document.getElementById('endAssignmentDate').value = localDate;
          document.getElementById('endAssignmentReason').value = '';
          document.getElementById('changeBatteriesEndForm').style.display = 'block';
        });
      });

      document.querySelectorAll('.change-batteries-replace-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          replaceAssignmentId = parseInt(this.getAttribute('data-id'), 10);
          replaceOldCode = this.getAttribute('data-code') || '';
          document.getElementById('replaceOldCode').textContent = replaceOldCode;
          const sel = document.getElementById('replaceNewBatterySelect');
          sel.innerHTML = '<option value="">— выбрать —</option>';
          batteries.forEach(b => {
            sel.innerHTML += '<option value="' + b.id + '">' + b.short_code + '</option>';
          });
          const now = new Date();
          document.getElementById('replaceDate').value = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 10);
          document.getElementById('replaceReason').value = 'Замена батареи';
          document.getElementById('changeBatteriesReplaceForm').style.display = 'block';
        });
      });
    }).catch(err => {
      document.getElementById('changeBatteriesError').textContent = 'Ошибка загрузки: ' + err.message;
      document.getElementById('changeBatteriesError').style.display = 'block';
      document.getElementById('changeBatteriesLoading').style.display = 'none';
    });
  }

  document.getElementById('changeBatteriesModal').addEventListener('show.bs.modal', function() {
    loadChangeBatteriesModal();
  });

  document.getElementById('changeBatteriesAddBtn').addEventListener('click', function() {
    const select = document.getElementById('changeBatteriesAddSelect');
    const batteryId = parseInt(select.value, 10);
    if (!batteryId) {
      showNotification('Ошибка', 'Выберите батарею', false);
      return;
    }
    const startEl = document.getElementById('changeBatteriesAddStart');
    const startAt = startEl.value || new Date().toISOString().slice(0, 10);
    const bat = changeBatteriesData.availableBatteries.find(b => b.id === batteryId);
    const code = bat ? bat.short_code : '';
    changeBatteriesPendingActions.push({
      type: 'add',
      battery_id: batteryId,
      start_at: startAt,
      battery_short_code: code
    });
    renderChangeBatteriesPending();
  });

  document.getElementById('changeBatteriesSubmitBtn').addEventListener('click', function() {
    if (!changeBatteriesPendingActions.length) {
      showNotification('Ошибка', 'Нет запланированных изменений', false);
      return;
    }
    const actions = changeBatteriesPendingActions.map(a => {
      const out = { type: a.type };
      if (a.type === 'end') {
        out.assignment_id = a.assignment_id;
        out.end_at = a.end_at;
        out.reason = a.reason || '';
      } else if (a.type === 'replace') {
        out.assignment_id = a.assignment_id;
        out.new_battery_id = a.new_battery_id;
        out.date = a.date;
        out.reason = a.reason || '';
      } else if (a.type === 'add') {
        out.battery_id = a.battery_id;
        out.start_at = a.start_at;
      }
      return out;
    });

    const btn = this;
    btn.disabled = true;
    fetch('/admin/rental/rental/' + rentalIdForBatteries + '/change-batteries/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({ actions: actions })
    })
    .then(r => r.json())
    .then(data => {
      btn.disabled = false;
      if (data.success) {
        showNotification('Успешно', data.message || 'Состав батарей обновлён');
        bootstrap.Modal.getInstance(document.getElementById('changeBatteriesModal')).hide();
        if (data.redirect_url) {
          setTimeout(() => window.location.href = data.redirect_url, 1200);
        } else {
          setTimeout(() => window.location.reload(), 1200);
        }
      } else {
        showNotification('Ошибка', data.error || 'Не удалось сохранить', false);
      }
    })
    .catch(err => {
      btn.disabled = false;
      showNotification('Ошибка', 'Ошибка запроса: ' + err.message, false);
    });
  });

  document.getElementById('replaceApplyBtn').addEventListener('click', function() {
    const sel = document.getElementById('replaceNewBatterySelect');
    const batteryId = parseInt(sel.value, 10);
    if (!batteryId || !replaceAssignmentId) return;
    const batteries = changeBatteriesData.availableBatteries || [];
    const bat = batteries.find(b => b.id === batteryId);
    const newCode = bat ? bat.short_code : '';
    const dateVal = document.getElementById('replaceDate').value;
    const dateStr = dateVal || new Date().toISOString().slice(0, 10);
    const reason = document.getElementById('replaceReason').value || 'Замена батареи';
    changeBatteriesPendingActions.push({
      type: 'replace',
      assignment_id: replaceAssignmentId,
      new_battery_id: batteryId,
      date: dateStr,
      reason: reason,
      battery_short_code: replaceOldCode,
      new_battery_short_code: newCode
    });
    document.getElementById('changeBatteriesReplaceForm').style.display = 'none';
    replaceAssignmentId = null;
    renderChangeBatteriesPending();
  });
  document.getElementById('replaceCancelBtn').addEventListener('click', function() {
    document.getElementById('changeBatteriesReplaceForm').style.display = 'none';
    replaceAssignmentId = null;
  });

  document.getElementById('endApplyBtn').addEventListener('click', function() {
    if (!endAssignmentId) return;
    const dateVal = document.getElementById('endAssignmentDate').value;
    const dateStr = dateVal || new Date().toISOString().slice(0, 10);
    const reason = document.getElementById('endAssignmentReason').value || '';
    changeBatteriesPendingActions.push({
      type: 'end',
      assignment_id: endAssignmentId,
      end_at: dateStr,
      reason: reason,
      battery_short_code: endBatteryCodeVal
    });
    document.getElementById('changeBatteriesEndForm').style.display = 'none';
    endAssignmentId = null;
    renderChangeBatteriesPending();
  });
  document.getElementById('endCancelBtn').addEventListener('click', function() {
    document.getElementById('changeBatteriesEndForm').style.display = 'none';
    endAssignmentId = null;
  });
</script>


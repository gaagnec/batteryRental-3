{% extends "admin/change_list.html" %}
{% load i18n %}
{% load static %}

{% block extrahead %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/bootstrap-icons.css' %}">
  <style>
    /* Hide default elements */
    #changelist-filter { display: none !important; }
    .actions { display: none !important; }

    /* Make content stretch full width */
    #content { width: 100% !important; max-width: none !important; }
    #changelist, .changelist-form-container, .results { width: 100% !important; }
    .changelist-form-container { margin: 0 !important; display: block !important; }

    /* Top synchronized scroll bar spans full width */
    .top-scroll { overflow-x: auto; height: 16px; margin: 0 0 .25rem 0; width: 100% !important; }
    .top-scroll .spacer { height: 1px; }

    /* Temporary: hide top scroll bar as requested */
    #top-scroll { display: none !important; }

    /* Make headers wrap to allow two-line labels */
    #result_list thead th { white-space: normal; word-break: break-word; vertical-align: middle; }
    #result_list thead th .two-lines { display: inline-block; line-height: 1.1; }

    /* Phoenix-style filters */
    .phoenix-filters-container {
      background-color: #1c1e2d;
      border: 1px solid #2a2e41;
      border-radius: 0.5rem;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }

    .phoenix-filters-row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-group {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .filter-label {
      color: #9fa6bc;
      font-size: 0.875rem;
      font-weight: 500;
      white-space: nowrap;
    }

    .filter-buttons {
      display: flex;
      gap: 0.375rem;
    }

    .filter-btn {
      padding: 0.375rem 0.875rem;
      border: 1px solid #2a2e41;
      background-color: #0e1018;
      color: #9fa6bc;
      border-radius: 0.25rem;
      font-size: 0.8125rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }

    .filter-btn:hover {
      background-color: #252840;
      color: #e9ecef;
      border-color: #667eea;
    }

    .filter-btn.active {
      background-color: #667eea;
      color: white;
      border-color: #667eea;
    }

    .search-group {
      flex: 1;
      min-width: 250px;
      max-width: 400px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 0.5rem 1rem 0.5rem 2.5rem;
      background-color: #0e1018;
      border: 1px solid #2a2e41;
      border-radius: 0.375rem;
      color: #e9ecef;
      font-size: 0.875rem;
    }

    .search-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .search-icon {
      position: absolute;
      left: 0.875rem;
      top: 50%;
      transform: translateY(-50%);
      color: #9fa6bc;
      font-size: 1rem;
      pointer-events: none;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .phoenix-filters-row {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-group {
        width: 100%;
      }

      .filter-buttons {
        flex-wrap: wrap;
      }

      .search-group {
        max-width: 100%;
      }
    }
  </style>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Apply Bootstrap-like classes to Django admin result table
      const tbl = document.getElementById('result_list');
      if (tbl) {
        tbl.classList.add('table','table-sm','table-hover','table-striped');
      }
      // Create top scroll that mirrors bottom
      const chg = document.getElementById('changelist');
      if (!chg) return;
      let top = document.getElementById('top-scroll');
      if (!top) {
        top = document.createElement('div');
        top.id = 'top-scroll';
        top.className = 'top-scroll';
        const spacer = document.createElement('div');
        spacer.className = 'spacer';
        spacer.style.width = '100%';
        top.appendChild(spacer);
        chg.insertBefore(top, chg.firstChild);
      }
      const container = document.querySelector('.results') || (tbl && tbl.parentElement);
      const updateWidth = () => {
        const target = tbl;
        if (top && target) {
          top.firstChild.style.width = target.scrollWidth + 'px';
        }
      };
      const sync = (src, dst) => { dst.scrollLeft = src.scrollLeft; };
      if (container && top) {
        updateWidth();
        top.addEventListener('scroll', () => sync(top, container));
        container.addEventListener('scroll', () => sync(container, top));
        window.addEventListener('resize', updateWidth);
        setTimeout(updateWidth, 200);
      }
      const actions = document.querySelector('.changelist-form-container .actions');
      if (actions) {
        actions.classList.add('compact-row');
        actions.querySelectorAll('select, input[type="text"], input[type="number"], input[type="date"]').forEach(el => {
          el.classList.add('form-control','form-control-sm');
        });
        actions.querySelectorAll('button, input[type="submit"]').forEach(el => {
          el.classList.add('btn','btn-sm','btn-primary');
        });
      }

      // AJAX Search
      const searchInput = document.getElementById('rentalSearch');
      if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
          clearTimeout(searchTimeout);
          const query = this.value.trim();
          
          if (query.length === 0) {
            // Reset to current filters
            return;
          }
          
          if (query.length < 2) {
            return; // Wait for at least 2 characters
          }
          
          searchTimeout = setTimeout(() => {
            performSearch(query);
          }, 500);
        });
      }

      function performSearch(query) {
        // Build URL with current filters
        const url = new URL(window.location.href);
        const params = new URLSearchParams(url.search);
        
        // Add search query
        if (query) {
          params.set('q', query);
        } else {
          params.delete('q');
        }
        
        // Navigate to new URL
        window.location.href = url.pathname + '?' + params.toString();
      }

      // Set search value from URL if present
      const urlParams = new URLSearchParams(window.location.search);
      const searchQuery = urlParams.get('q');
      if (searchQuery && searchInput) {
        searchInput.value = searchQuery;
      }
    });
  </script>

  <style>
    .input-group > * {
      flex: 1 1 0%;
      min-width: 0;
    }
    .input-group-sm > * {
      font-size: 0.875rem;
      padding: 0.25rem 0.5rem;
    }
    .compact-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .compact-row > * {
      flex: 1 1 calc(33.333% - 0.5rem);
      min-width: 0;
    }
  </style>
  <style>
    @media (max-width: 576px) {
      .compact-row > * {
        flex: 1 1 100% !important;
      }
      .btn-group.btn-group-sm {
        display: flex !important;
        flex-direction: column !important;
        width: 100% !important;
      }
      .btn-group.btn-group-sm .btn {
        width: 100% !important;
        margin-bottom: 0.25rem !important;
      }
    }
  </style>
{% endblock %}

{% block object-tools-items %}
  <!-- Phoenix-style Filters Container -->
  <div class="phoenix-filters-container" style="width: 100%; list-style: none; margin: 0 0 1rem 0; padding: 0;">
    <div class="phoenix-filters-row">
      <!-- Status Filter -->
      <div class="filter-group">
        <span class="filter-label">
          <i class="bi bi-funnel"></i>
          Статус:
        </span>
        <div class="filter-buttons">
          {% with cur=request.GET.status__exact %}
            <a class="filter-btn {% if not cur %}active{% endif %}" href=".">Все</a>
            <a class="filter-btn {% if cur == 'active' %}active{% endif %}" href="?status__exact=active">Активен</a>
            <a class="filter-btn {% if cur == 'modified' %}active{% endif %}" href="?status__exact=modified">Модифицирован</a>
            <a class="filter-btn {% if cur == 'closed' %}active{% endif %}" href="?status__exact=closed">Закрыт</a>
          {% endwith %}
        </div>
      </div>

      <!-- City Filter (Admin only) -->
      {% if user.is_superuser %}
      <div class="filter-group">
        <span class="filter-label">
          <i class="bi bi-geo-alt"></i>
          Город:
        </span>
        <div class="filter-buttons">
          {% with cur_city=request.GET.city__id__exact %}
            <a class="filter-btn {% if not cur_city %}active{% endif %}" href="{% if request.GET.status__exact %}?status__exact={{ request.GET.status__exact }}{% else %}.{% endif %}">Все</a>
            {% for city in cities %}
              <a class="filter-btn {% if cur_city == city.id|stringformat:'s' %}active{% endif %}" 
                 href="?city__id__exact={{ city.id }}{% if request.GET.status__exact %}&status__exact={{ request.GET.status__exact }}{% endif %}">
                {{ city.name }}
              </a>
            {% endfor %}
          {% endwith %}
        </div>
      </div>
      {% endif %}

      <!-- AJAX Search -->
      <div class="search-group">
        <i class="bi bi-search search-icon"></i>
        <input type="text" 
               class="search-input" 
               id="rentalSearch" 
               placeholder="Поиск по клиенту, коду договора или статусу..." 
               autocomplete="off">
      </div>
    </div>
  </div>

  {{ block.super }}
{% endblock %}

{% block result_list %}
  <div class="table-responsive">
    {{ block.super }}
  </div>
{% endblock %}

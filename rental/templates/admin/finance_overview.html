{% extends "admin/base_site.html" %}
{% load i18n %}
{% block content %}
<h1>Финансы — Обзор</h1>
<form method="get" class="form-inline" style="margin-bottom:12px">
  <label>Период:&nbsp;</label>
  <select name="preset">
    <option value="month" {% if request.GET.preset|default:'month' == 'month' %}selected{% endif %}>Текущий месяц</option>
    <option value="prev" {% if request.GET.preset == 'prev' %}selected{% endif %}>Прошлый месяц</option>
    <option value="ytd" {% if request.GET.preset == 'ytd' %}selected{% endif %}>С начала года</option>
    <option value="custom" {% if request.GET.preset == 'custom' %}selected{% endif %}>Произвольный</option>
  </select>
  <input type="date" name="start" value="{{ start|date:'Y-m-d' }}">
  <input type="date" name="end" value="{{ end|date:'Y-m-d' }}">
  <button type="submit" class="button">Показать</button>
</form>

<h3>Доходы (Payments type ∈ {rent, sold})</h3>
<table class="admin-table">
  <thead><tr><th>Пользователь</th><th>Сумма</th></tr></thead>
  <tbody>
  {% for row in income_rows %}
    <tr><td>{{ row.created_by__username }}</td><td>{{ row.total }}</td></tr>
  {% empty %}
    <tr><td colspan="2">Нет данных</td></tr>
  {% endfor %}
  </tbody>
  <tfoot>
    <tr><th>Итого</th><th>{{ income_total }}</th></tr>
  </tfoot>
</table>

<h3>Собранные</h3>
<table class="admin-table">
  <thead><tr><th>Партнёр</th><th>Остаток на начало</th><th>Дельта за период</th><th>Остаток на конец</th></tr></thead>
  <tbody>
  {% for row in collected_rows %}
    <tr><td>{{ row.username }}</td><td>{{ row.open }}</td><td>{{ row.delta }}</td><td>{{ row.close }}</td></tr>
  {% empty %}
    <tr><td colspan="4">Нет данных</td></tr>
  {% endfor %}
  </tbody>
  <tfoot>
    <tr><th>Итого</th>
      <th>{{ collected_open_total }}</th>
      <th>{{ collected_delta_total }}</th>
      <th>{{ collected_total }}</th>
    </tr>
  </tfoot>
</table>

<h3>Вложено</h3>
<table class="admin-table">
  <thead><tr><th>Владелец</th><th>Остаток на начало</th><th>Дельта за период</th><th>Остаток на конец</th></tr></thead>
  <tbody>
  {% for row in invested_rows %}
    <tr><td>{{ row.username }}</td><td>{{ row.open }}</td><td>{{ row.delta }}</td><td>{{ row.close }}</td></tr>
  {% empty %}
    <tr><td colspan="4">Нет данных</td></tr>
  {% endfor %}
  </tbody>
  <tfoot>
    <tr><th>Итого</th>
      <th>{{ invested_open_total }}</th>
      <th>{{ invested_delta_total }}</th>
      <th>{{ invested_total }}</th>
    </tr>
  </tfoot>
</table>

<h3>Взаиморасчёты владельцев</h3>
<table class="admin-table">
  <thead><tr><th>От</th><th>Кому</th><th>Сумма</th></tr></thead>
  <tbody>
  {% for row in settlements_rows %}
    <tr><td>{{ row.from }}</td><td>{{ row.to }}</td><td>{{ row.total }}</td></tr>
  {% empty %}
    <tr><td colspan="3">Нет данных</td></tr>
  {% endfor %}
  </tbody>
  <tfoot>
    <tr><th>Итого</th><th></th><th>{{ settlements_total }}</th></tr>
  </tfoot>
</table>
<p><em>Корректировки взаиморасчётов:</em> {{ settlements_adj_total }}</p>

<h3>Распределение прибыли</h3>
<p>Доход: {{ profit_income }} | Расходы компании: {{ profit_expenses }} | Прибыль (P): {{ profit_total }}</p>
<table class="admin-table">
  <thead><tr><th>Владелец</th><th>Доля, %</th><th>Полагается (из прибыли)</th><th>Выдано</th><th>Следовало выдать из выданного</th><th>Долг компании</th></tr></thead>
  <tbody>
  {% for row in profit_rows %}
    <tr>
      <td>{{ row.username }}</td>
      <td>{{ row.share }}</td>
      <td>{{ row.due }}</td>
      <td>{{ row.withdrawn }}</td>
      <td>{{ row.withdrawn_should }}</td>
      <td>{{ row.company_owes }}</td>
    </tr>
  {% empty %}
    <tr><td colspan="6">Нет данных</td></tr>
  {% endfor %}
  </tbody>
</table>
<h4>Рекомендуемые взаиморасчёты между владельцами (за уже выданное)</h4>
<table class="admin-table">
  <thead><tr><th>От</th><th>Кому</th><th>Сумма</th></tr></thead>
  <tbody>
  {% for row in profit_settlements_suggest %}
    <tr><td>{{ row.from }}</td><td>{{ row.to }}</td><td>{{ row.total }}</td></tr>
  {% empty %}
    <tr><td colspan="3">Нет</td></tr>
  {% endfor %}
  </tbody>
</table>
<p><em>Невыданная часть прибыли (долг компании владельцам):</em> {{ profit_company_owes_total }}</p>
{% endblock %}

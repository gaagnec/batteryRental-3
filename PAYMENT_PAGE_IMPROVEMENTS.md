# Улучшения страницы добавления платежа

## Дата: 2025-10-27
## Ветка: payment-page-improvements

## Описание изменений

### 1. Фильтрация поля "Аренда"
- **По умолчанию**: отображаются только активные договора последней версии
  - Статус: `ACTIVE`
  - Последняя версия: договор не имеет детей (children_count = 0)
  - Сортировка: от большего ID к меньшему (`-id`)

### 2. Чекбокс "Показать все договора"
- Добавлена галочка для переключения между режимами отображения
- При установке галочки:
  - Отображаются ВСЕ договора (включая закрытые и старые версии)
  - Сохраняется сортировка от большего к меньшему
- Состояние сохраняется в URL параметре `show_all_rentals=1`

### 3. Темная тема
- Применен темный стиль как на странице `/admin/dashboard/`
- Цветовая палитра:
  - Фон: `#0b0d1a`
  - Карточки: `#1c1e2d`
  - Границы: `#2a2e41`
  - Текст: `#e3e6ed`
  - Акценты: `#8ad0ff`, `#00d27a`, `#ff6b6b`

### 4. Переименование поля
- Поле "Rental" переименовано на "Аренда" (verbose_name)

## Технические детали

### Измененные файлы:

1. **rental/admin.py**
   - Добавлен `change_form_template`
   - Добавлен метод `formfield_for_foreignkey()` для фильтрации
   - Добавлен метод `render_change_form()` для передачи контекста

2. **rental/models.py**
   - Добавлен `verbose_name="Аренда"` для поля `rental` в модели `Payment`

3. **rental/templates/admin/rental/payment/change_form.html**
   - Добавлены CSS стили для темной темы
   - Добавлен чекбокс "Показать все договора"
   - Добавлен JavaScript для обработки переключения

## Как использовать

### Для пользователей:
1. Перейдите на страницу добавления платежа: `/admin/rental/payment/add/`
2. По умолчанию в поле "Аренда" отображаются только активные договора
3. Чтобы увидеть все договора, установите галочку "Показать все договора"
4. Страница перезагрузится с новым списком договоров

### Для разработчиков:
- Фильтрация реализована через `formfield_for_foreignkey()`
- Параметр `show_all_rentals` передается через GET
- QuerySet фильтруется с использованием аннотации `children_count`

## Примеры запросов

### Только активные договора (по умолчанию):
```python
Rental.objects.select_related('client').annotate(
    children_count=Count('children')
).filter(
    Q(status=Rental.Status.ACTIVE) & Q(children_count=0)
).order_by('-id')
```

### Все договора (с галочкой):
```python
Rental.objects.select_related('client').order_by('-id')
```

## Тестирование

Для проверки работоспособности:
1. Убедитесь, что миграции применены
2. Перейдите на `/admin/rental/payment/add/`
3. Проверьте отображение только активных договоров
4. Установите галочку "Показать все договора"
5. Убедитесь, что теперь отображаются все договора
6. Проверьте сортировку (от большего к меньшему)
7. Проверьте темную тему

## Известные ограничения

Нет известных ограничений или проблем.

## Дополнительная информация

- Изменения обратно совместимы
- Не требуется создание новых миграций (только изменение verbose_name)
- Темная тема применяется только к странице добавления/редактирования платежа

{% extends "admin/base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}Battery Rental Admin | {{ block.super }}{% endblock %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
  <link rel="stylesheet" href="{% static 'css/bootstrap-icons.css' %}">
  <link rel="stylesheet" href="{% static 'css/admin-phoenix.css' %}">
{% endblock %}

{% block bodyclass %}{{ block.super }} phoenix-admin{% endblock %}

{% block header %}
  {% if user.is_authenticated %}
  <!-- Top Navigation -->
  <nav class="phoenix-navbar">
    <!-- Burger Menu Button (Mobile Only) -->
    <button class="phoenix-burger" id="sidebarToggle" aria-label="Toggle sidebar">
      <i class="bi bi-list" style="font-size: 1.5rem;"></i>
    </button>
    
    <a href="{% url 'admin:index' %}" class="phoenix-navbar-brand">
      <i class="bi bi-lightning-charge-fill"></i>
      <span>Battery Rental</span>
    </a>
    
    <ul class="phoenix-navbar-nav">
      <li>
        <a href="{% url 'admin:index' %}" class="{% if request.resolver_match.url_name == 'index' %}active{% endif %}" title="Главная">
          <i class="bi bi-house-door"></i>
          <span>Главная</span>
        </a>
      </li>
      <li>
        <a href="{% url 'admin:rental_rental_changelist' %}" class="{% if 'rental_rental' in request.resolver_match.url_name %}active{% endif %}" title="Договора">
          <i class="bi bi-file-earmark-text"></i>
          <span>Договора</span>
        </a>
      </li>
      <li>
        <a href="{% url 'admin:rental_payment_changelist' %}" class="{% if 'payment' in request.resolver_match.url_name %}active{% endif %}" title="Платежи">
          <i class="bi bi-credit-card"></i>
          <span>Платежи</span>
        </a>
      </li>
      <li>
        <a href="{% url 'admin-dashboard' %}" class="{% if 'dashboard' in request.path %}active{% endif %}" title="Dashboard">
          <i class="bi bi-graph-up"></i>
          <span>Dashboard</span>
        </a>
      </li>
    </ul>
    
    <div class="phoenix-navbar-right">
      {% if user.is_staff %}
      <a href="{% url 'download-debug-log' %}" class="phoenix-navbar-icon" title="Скачать debug лог">
        <i class="bi bi-file-text"></i>
      </a>
      {% endif %}
      <div class="phoenix-user-menu">
        <div class="phoenix-user-avatar">
          {{ user.username|slice:":1"|upper }}
        </div>
        <span>{{ user.username }}</span>
      </div>
    </div>
  </nav>

  <!-- Sidebar -->
  <aside class="phoenix-sidebar" id="phoenixSidebar">
    {% check_moderator user as user_is_moderator %}
    <ul class="phoenix-sidebar-menu">
      <!-- Главная -->
      <li class="phoenix-sidebar-section">Главная</li>
      <li class="phoenix-sidebar-item">
        <a href="{% url 'admin-dashboard' %}" class="phoenix-sidebar-link {% if 'dashboard' in request.path %}active{% endif %}">
          <i class="bi bi-graph-up"></i>
          <span>Dashboard</span>
        </a>
      </li>
      {% if not user_is_moderator %}
      <li class="phoenix-sidebar-item">
        <a href="{% url 'city-analytics' %}" class="phoenix-sidebar-link {% if 'city-analytics' in request.path %}active{% endif %}">
          <i class="bi bi-geo-alt"></i>
          <span>Аналитика по городам</span>
        </a>
      </li>
      {% endif %}
      
      <!-- Основное -->
      <li class="phoenix-sidebar-section">Основное</li>
      <li class="phoenix-sidebar-item">
        <a href="{% url 'admin:rental_client_changelist' %}" class="phoenix-sidebar-link {% if 'client' in request.resolver_match.url_name %}active{% endif %}">
          <i class="bi bi-people"></i>
          <span>Клиенты</span>
        </a>
      </li>
      <li class="phoenix-sidebar-item">
        <a href="{% url 'admin:rental_rental_changelist' %}" class="phoenix-sidebar-link {% if 'rental_rental' in request.resolver_match.url_name %}active{% endif %}">
          <i class="bi bi-file-earmark-text"></i>
          <span>Договора</span>
        </a>
      </li>
      <li class="phoenix-sidebar-item">
        <a href="{% url 'admin:rental_payment_changelist' %}" class="phoenix-sidebar-link {% if 'payment' in request.resolver_match.url_name %}active{% endif %}">
          <i class="bi bi-credit-card"></i>
          <span>Платежи</span>
        </a>
      </li>
      
      <!-- Оборудование (скрыто для модераторов) -->
      {% if not user_is_moderator %}
      <li class="phoenix-sidebar-section">Оборудование</li>
      <li class="phoenix-sidebar-item">
        <a href="{% url 'admin:rental_battery_changelist' %}" class="phoenix-sidebar-link {% if 'battery' in request.resolver_match.url_name %}active{% endif %}">
          <i class="bi bi-battery-charging"></i>
          <span>Батареи</span>
        </a>
      </li>
      <li class="phoenix-sidebar-item">
        <a href="{% url 'admin:rental_batterytransfer_changelist' %}" class="phoenix-sidebar-link {% if 'batterytransfer' in request.resolver_match.url_name %}active{% endif %}">
          <i class="bi bi-arrow-left-right"></i>
          <span>Переносы батарей</span>
        </a>
      </li>
      <li class="phoenix-sidebar-item">
        <a href="{% url 'admin:rental_repair_changelist' %}" class="phoenix-sidebar-link {% if 'repair' in request.resolver_match.url_name %}active{% endif %}">
          <i class="bi bi-tools"></i>
          <span>Ремонты</span>
        </a>
      </li>
      <li class="phoenix-sidebar-item">
        <a href="{% url 'admin:rental_batterystatuslog_changelist' %}" class="phoenix-sidebar-link {% if 'batterystatuslog' in request.resolver_match.url_name %}active{% endif %}">
          <i class="bi bi-clock-history"></i>
          <span>Логи статусов</span>
        </a>
      </li>
      {% endif %}
      
      <!-- Финансы (скрыто для модераторов) -->
      {% if not user_is_moderator %}
      <li class="phoenix-sidebar-section">Финансы</li>
      <li class="phoenix-sidebar-item">
        <a href="{% url 'admin:rental_financeoverviewproxy2_changelist' %}" class="phoenix-sidebar-link {% if 'financeoverview' in request.resolver_match.url_name %}active{% endif %}">
          <i class="bi bi-calculator"></i>
          <span>Бухучет</span>
        </a>
      </li>
      <li class="phoenix-sidebar-item">
        <a href="{% url 'admin:rental_ownerwithdrawal_changelist' %}" class="phoenix-sidebar-link {% if 'ownerwithdrawal' in request.resolver_match.url_name %}active{% endif %}">
          <i class="bi bi-cash-coin"></i>
          <span>Выплаты</span>
        </a>
      </li>
      <li class="phoenix-sidebar-item">
        <a href="{% url 'admin:rental_moneytransfer_changelist' %}" class="phoenix-sidebar-link {% if 'moneytransfer' in request.resolver_match.url_name %}active{% endif %}">
          <i class="bi bi-arrow-left-right"></i>
          <span>Переводы</span>
        </a>
      </li>
      <li class="phoenix-sidebar-item">
        <a href="{% url 'admin:rental_financeadjustment_changelist' %}" class="phoenix-sidebar-link {% if 'financeadjustment' in request.resolver_match.url_name %}active{% endif %}">
          <i class="bi bi-pencil-square"></i>
          <span>Корректировки</span>
        </a>
      </li>
      <li class="phoenix-sidebar-item">
        <a href="{% url 'admin:rental_expense_changelist' %}" class="phoenix-sidebar-link {% if 'expense' in request.resolver_match.url_name %}active{% endif %}">
          <i class="bi bi-receipt"></i>
          <span>Расходы</span>
        </a>
      </li>
      {% endif %}
      
      <!-- Система -->
      <li class="phoenix-sidebar-section">Система</li>
      {% if not user_is_moderator %}
      <li class="phoenix-sidebar-item">
        <a href="{% url 'admin:rental_financepartner_changelist' %}" class="phoenix-sidebar-link {% if 'financepartner' in request.resolver_match.url_name %}active{% endif %}">
          <i class="bi bi-person-badge"></i>
          <span>Партнеры</span>
        </a>
      </li>
      {% endif %}
      <li class="phoenix-sidebar-item">
        <a href="{% url 'admin:password_change' %}" class="phoenix-sidebar-link">
          <i class="bi bi-key"></i>
          <span>Сменить пароль</span>
        </a>
      </li>
      <li class="phoenix-sidebar-item">
        <form method="post" action="{% url 'admin:logout' %}" style="margin: 0; padding: 0;">
          {% csrf_token %}
          <button type="submit" class="phoenix-sidebar-link" style="background: none; border: none; width: 100%; text-align: left; cursor: pointer;">
            <i class="bi bi-box-arrow-right"></i>
            <span>Выход</span>
          </button>
        </form>
      </li>
    </ul>
  </aside>
  
  <!-- Overlay for mobile -->
  <div class="phoenix-overlay" id="sidebarOverlay"></div>
  {% endif %}
{% endblock %}

{% block footer %}
  {{ block.super }}
  <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
  <script>
    // Force dark mode
    document.documentElement.style.colorScheme = 'dark';
    document.body.style.colorScheme = 'dark';
    
    // Mobile sidebar toggle
    (function() {
      const burger = document.getElementById('sidebarToggle');
      const sidebar = document.getElementById('phoenixSidebar');
      const overlay = document.getElementById('sidebarOverlay');
      
      if (burger && sidebar && overlay) {
        // Toggle sidebar
        burger.addEventListener('click', function() {
          sidebar.classList.toggle('open');
          overlay.classList.toggle('active');
          document.body.classList.toggle('sidebar-open');
        });
        
        // Close sidebar when clicking overlay
        overlay.addEventListener('click', function() {
          sidebar.classList.remove('open');
          overlay.classList.remove('active');
          document.body.classList.remove('sidebar-open');
        });
        
        // Close sidebar when clicking a link (mobile only)
        if (window.innerWidth < 992) {
          const sidebarLinks = sidebar.querySelectorAll('.phoenix-sidebar-link');
          sidebarLinks.forEach(link => {
            link.addEventListener('click', function() {
              sidebar.classList.remove('open');
              overlay.classList.remove('active');
              document.body.classList.remove('sidebar-open');
            });
          });
        }
      }
    })();
  </script>
{% endblock %}
